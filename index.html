<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Money Heist: P2P Battle</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #0f0d0b; --accent: #7c1510; --cream: #e2d6c7; 
            --green: #2ecc71; --red: #e74c3c; --blue: #3498db; 
            --yellow: #f1c40f; 
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); color: var(--cream); font-family: 'Montserrat', sans-serif; 
            margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; height: 100vh;
            overflow: hidden; /* Prevent scrolling, use tabs instead */
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* --- UI COMPONENTS --- */
        h1, h2, h3 { font-family: 'Oswald', sans-serif; text-transform: uppercase; margin: 0; }
        button { cursor: pointer; font-family: 'Oswald', sans-serif; text-transform: uppercase; font-weight: bold; }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; padding: 20px; z-index: 10; }
        .screen.active { display: flex; }

        /* LOBBY & FORMS */
        .card { background: rgba(255,255,255,0.05); padding: 20px; border: 1px solid rgba(255,255,255,0.1); width: 100%; max-width: 400px; text-align: center; border-radius: 8px; margin-top: 20px; }
        input { background: #222; border: 1px solid #444; color: white; padding: 15px; width: 100%; margin: 10px 0; font-family: monospace; text-align: center; font-size: 1.2rem; }
        .big-btn { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; font-size: 1.2rem; margin-top: 10px; border-radius: 4px; transition: 0.2s; }
        .big-btn:active { transform: scale(0.98); }
        .big-btn:disabled { background: #444; color: #888; }

        /* GRID SYSTEM (Responsive & Bigger) */
        .grid-container {
            flex: 1; display: flex; align-items: center; justify-content: center; width: 100%; padding: 10px;
        }
        .grid { 
            display: grid; grid-template-columns: repeat(12, 1fr); gap: 2px; 
            width: 100%; max-width: 95vw; aspect-ratio: 1;
        }
        /* Row/Col Headers hidden to save space, using cell text instead */
        .cell { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 0.7rem; color: #444; position: relative; font-family: 'Oswald', sans-serif; 
        }
        
        /* STATUS & HUD */
        .hud { 
            width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; background: #1a1815; border-bottom: 2px solid var(--accent); 
        }
        .status-badge { padding: 5px 10px; background: #333; font-size: 0.9rem; border-radius: 4px; color: #aaa; }
        .status-badge.connected { color: var(--green); border: 1px solid var(--green); }
        .status-badge.disconnected { color: var(--red); border: 1px solid var(--red); animation: pulse 1s infinite; }

        /* TABS (For View Switching) */
        .tab-controls {
            display: flex; width: 100%; max-width: 600px; margin-bottom: 10px; gap: 10px;
        }
        .tab-btn { flex: 1; padding: 15px; background: #222; color: #666; border: 1px solid #333; font-size: 1.2rem; }
        .tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .game-view { display: none; width: 100%; flex-direction: column; align-items: center; flex: 1; }
        .game-view.active { display: flex; }

        /* CELL STATES */
        .cell.occupied { background: #555 !important; border-color: #777; } /* Setup Only */
        
        /* Radar (Attack) */
        .radar .cell:active { background: rgba(231, 76, 60, 0.3); }
        .radar .cell.hit { background: var(--red) !important; color: white; border: 1px solid white; }
        .radar .cell.miss { background: var(--green) !important; opacity: 0.4; }
        .radar .cell.pending { background: var(--yellow) !important; animation: pulse 0.5s infinite; }

        /* Fleet (Defense) */
        .fleet .cell.my-ship { background: #444; border: 1px solid #666; }
        .fleet .cell.hit { background: var(--red) !important; border: 2px solid white; z-index: 2; }
        .fleet .cell.miss { background: var(--blue) !important; opacity: 0.3; }

        /* ANIMATION OVERLAY */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .overlay.active { opacity: 1; }
        .overlay-coord { font-family: 'Oswald', sans-serif; font-size: 5rem; font-weight: 700; color: var(--cream); }
        .overlay-status { font-family: 'Oswald', sans-serif; font-size: 2rem; text-transform: uppercase; margin-top: 10px; text-align: center; color: var(--accent); }
        
        .status-hit { color: var(--red); text-shadow: 0 0 20px red; }
        .status-sunk { color: var(--red); font-size: 3rem; border: 4px solid var(--red); padding: 20px; background: black; }
        .status-win { color: var(--green); font-size: 3rem; text-shadow: 0 0 20px var(--green); }
        .status-miss { color: var(--blue); }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="overlay" id="anim-overlay">
        <div class="overlay-coord" id="anim-main"></div>
        <div class="overlay-status" id="anim-sub"></div>
    </div>

    <div id="screen-lobby" class="screen active">
        <h1 style="font-size: 3rem; color: var(--accent);">HEIST BATTLE</h1>
        <div class="card">
            <h3>Start Mission</h3>
            <button class="big-btn" onclick="hostGame()">Create Room</button>
            <div style="margin: 20px; color: #666;">- OR -</div>
            <h3>Join Crew</h3>
            <input type="text" id="join-id" placeholder="Enter Room ID">
            <button class="big-btn" onclick="joinGame()">Connect</button>
        </div>
        <div style="margin-top: 20px; color: #444; font-size: 0.8rem;">Peer-to-Peer Encrypted</div>
    </div>

    <div id="screen-wait" class="screen">
        <h1>UPLINK ESTABLISHED</h1>
        <div class="card">
            <p style="color:#888;">Share this code with your opponent:</p>
            <div id="host-id-display" style="font-size: 2rem; font-family: monospace; color: var(--green); border: 1px dashed #555; padding: 10px; margin: 10px 0; user-select: text;">Loading...</div>
            <div id="wait-msg">Waiting for connection...</div>
        </div>
    </div>

    <div id="screen-setup" class="screen">
        <div class="hud">
            <span>DEPLOYING: <strong id="ship-name-display" style="color:var(--yellow)">...</strong></span>
            <button onclick="resetSetup()" style="background:transparent; border:1px solid #555; color:#888; padding:5px;">RESET</button>
        </div>
        
        <div class="grid-container">
            <div class="grid" id="setup-grid"></div>
        </div>

        <div style="width:100%; max-width:600px; display:flex; gap:10px;">
            <button class="big-btn" style="flex:1; background:#444;" onclick="toggleAxis()">Rotate: <span id="axis-display">HORIZ</span></button>
            <button class="big-btn" style="flex:1; display:none; background:var(--green); color:black;" id="confirm-btn" onclick="finalizeSetup()">CONFIRM</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="hud">
            <div id="conn-status" class="status-badge connected">ONLINE</div>
            <div id="turn-display" style="font-weight:bold;">WAITING...</div>
        </div>

        <div class="tab-controls">
            <button class="tab-btn active" onclick="setTab('radar')" id="btn-radar">RADAR (ATTACK)</button>
            <button class="tab-btn" onclick="setTab('fleet')" id="btn-fleet">MY FLEET</button>
        </div>

        <div class="game-view active" id="view-radar">
            <div class="grid-container">
                <div class="grid radar" id="radar-grid"></div>
            </div>
            <div style="text-align:center; color:#666; margin-top:10px;">Tap grid to fire</div>
        </div>

        <div class="game-view" id="view-fleet">
            <div class="grid-container">
                <div class="grid fleet" id="fleet-grid"></div>
            </div>
            <div style="text-align:center; color:#666; margin-top:10px;">Monitor damage</div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        // Ship names corresponding to size
        const SHIP_DATA = [
            { name: "THE PROFESSOR", size: 5 },
            { name: "BERLIN", size: 4 },
            { name: "TOKYO", size: 3 },
            { name: "NAIROBI", size: 3 },
            { name: "RIO", size: 2 }
        ];

        // --- STATE ---
        let peer, conn;
        let mySide = ''; 
        let myTurn = false;
        let isConnected = false;
        let heartbeatInterval;

        // Setup State
        let currentShipIdx = 0;
        let isHorizontal = true;
        let myShips = []; // Stores {name, size, coords: [], hits: 0}
        let totalMyShipsLost = 0;

        const rows = ['A','B','C','D','E','F','G','H'];
        const cols = 12;

        // --- NETWORK LOGIC (Stability Added) ---
        function initPeer(id = null) {
            peer = new Peer(id, { debug: 1 });
            
            peer.on('open', (id) => {
                if(mySide === 'host') {
                    document.getElementById('host-id-display').innerText = id;
                    switchScreen('screen-wait');
                }
            });

            peer.on('connection', (c) => handleConnection(c));
            peer.on('disconnected', () => updateConnStatus(false));
            peer.on('error', (err) => alert("Network Error: " + err));
        }

        function handleConnection(c) {
            if(conn) conn.close();
            conn = c;
            
            conn.on('open', () => {
                isConnected = true;
                updateConnStatus(true);
                startHeartbeat();
                
                // If we are in lobby/wait, move to setup
                if(document.getElementById('screen-lobby').classList.contains('active') || 
                   document.getElementById('screen-wait').classList.contains('active')) {
                    switchScreen('screen-setup');
                    initSetupGrid();
                }
            });

            conn.on('data', (data) => handleData(data));
            
            conn.on('close', () => {
                isConnected = false;
                updateConnStatus(false);
                alert("Connection Lost! Waiting for reconnect...");
            });
        }

        function startHeartbeat() {
            if(heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(() => {
                if(conn && conn.open) conn.send({ type: 'PING' });
            }, 2000);
        }

        function hostGame() {
            mySide = 'host';
            myTurn = true;
            initPeer();
        }

        function joinGame() {
            const id = document.getElementById('join-id').value.trim();
            if(!id) return alert("Enter ID");
            mySide = 'client';
            myTurn = false;
            peer = new Peer();
            peer.on('open', () => {
                handleConnection(peer.connect(id));
            });
        }

        function send(payload) {
            if(conn && conn.open) conn.send(payload);
        }

        // --- DATA HANDLER ---
        function handleData(data) {
            if(data.type === 'PING') return; // Heartbeat ignore

            if(data.type === 'READY') {
                if(mySide === 'host') checkStart(); // Host decides when to start
                else document.getElementById('ship-name-display').innerText = "OPPONENT READY";
            }

            if(data.type === 'START') {
                initGameUI();
            }

            // INCOMING FIRE (Enemy Shot at Me)
            if(data.type === 'FIRE') {
                processIncomingAttack(data.coord);
            }

            // RESULT OF MY SHOT (I Shot at Enemy)
            if(data.type === 'RESULT') {
                processAttackResult(data);
            }

            // GAME OVER
            if(data.type === 'GAMEOVER') {
                showOverlay("VICTORY", "THE HEIST IS SUCCESSFUL", "status-win", 10000);
            }
        }

        // --- GAME LOGIC ---

        function processIncomingAttack(coord) {
            // Check hit locally
            let hitShip = null;
            let isSunk = false;

            for(let ship of myShips) {
                if(ship.coords.includes(coord)) {
                    ship.hits++;
                    hitShip = ship;
                    if(ship.hits === ship.size) {
                        isSunk = true;
                        totalMyShipsLost++;
                    }
                    break;
                }
            }

            // Visuals
            const result = hitShip ? 'hit' : 'miss';
            const msg = isSunk ? `LOST ${hitShip.name}` : (hitShip ? "IMPACT!" : "SAFE");
            
            showOverlay(coord, msg, hitShip ? "status-hit" : "status-miss");
            
            const cell = document.getElementById(`fleet-${coord}`);
            if(cell) cell.classList.add(result);

            // Send Result back
            send({
                type: 'RESULT',
                coord: coord,
                hit: !!hitShip,
                sunkName: isSunk ? hitShip.name : null
            });

            // Check Loss
            if(totalMyShipsLost === SHIP_DATA.length) {
                setTimeout(() => {
                    send({ type: 'GAMEOVER' });
                    showOverlay("DEFEAT", "FLEET DESTROYED", "status-hit", 10000);
                }, 2000);
            }

            setTurn(true); // Now it's my turn
        }

        function processAttackResult(data) {
            const cell = document.getElementById(`radar-${data.coord}`);
            cell.classList.remove('pending');
            cell.classList.add(data.hit ? 'hit' : 'miss');

            if(data.sunkName) {
                showOverlay("DESTROYED", data.sunkName, "status-sunk", 3000);
            } else {
                showOverlay(data.coord, data.hit ? "DIRECT HIT" : "MISSED", data.hit ? "status-hit" : "status-miss");
            }
        }

        // --- SETUP LOGIC ---
        function initSetupGrid() {
            createGrid('setup-grid', 'setup', (r, c) => placeShip(r, c));
            updateSetupUI();
        }

        function placeShip(r, c) {
            if(currentShipIdx >= SHIP_DATA.length) return;
            
            const shipInfo = SHIP_DATA[currentShipIdx];
            const coords = getCoords(r, c, shipInfo.size);

            if(!coords) return; // Invalid placement
            
            // Overlap check
            for(let existing of myShips) {
                for(let co of coords) {
                    if(existing.coords.includes(co)) return alert("Overlap!");
                }
            }

            // Save ship
            myShips.push({
                name: shipInfo.name,
                size: shipInfo.size,
                coords: coords,
                hits: 0
            });

            // Draw
            coords.forEach(co => {
                document.querySelector(`.cell[data-id="setup-${co}"]`).classList.add('occupied');
            });

            currentShipIdx++;
            updateSetupUI();
        }

        function updateSetupUI() {
            if(currentShipIdx < SHIP_DATA.length) {
                document.getElementById('ship-name-display').innerText = SHIP_DATA[currentShipIdx].name + ` (${SHIP_DATA[currentShipIdx].size})`;
            } else {
                document.getElementById('ship-name-display').innerText = "FLEET READY";
                document.getElementById('confirm-btn').style.display = 'block';
            }
        }

        function finalizeSetup() {
            document.getElementById('confirm-btn').disabled = true;
            document.getElementById('confirm-btn').innerText = "WAITING...";
            send({ type: 'READY' });
            if(mySide === 'host') checkStart();
        }

        function checkStart() {
            // Naive check: In a real app we'd wait for both explicit ready signals
            // Here we assume if I clicked confirm and I received READY from other, we go.
            if(currentShipIdx === SHIP_DATA.length && document.getElementById('confirm-btn').disabled) {
                send({ type: 'START' });
                initGameUI();
            }
        }

        // --- GAMEPLAY UI ---
        function initGameUI() {
            switchScreen('screen-game');
            createGrid('radar-grid', 'radar', (r, c) => handleFire(r, c));
            createGrid('fleet-grid', 'fleet', null);

            // Render my ships on fleet grid
            myShips.forEach(ship => {
                ship.coords.forEach(co => {
                    document.getElementById(`fleet-${co}`).classList.add('my-ship');
                });
            });

            setTurn(myTurn);
        }

        function handleFire(r, c) {
            if(!myTurn) return;
            const coord = `${r}${c}`;
            const cell = document.getElementById(`radar-${coord}`);
            
            if(cell.classList.contains('hit') || cell.classList.contains('miss') || cell.classList.contains('pending')) return;

            cell.classList.add('pending');
            setTurn(false);
            send({ type: 'FIRE', coord: coord });
        }

        function setTurn(isMine) {
            myTurn = isMine;
            const el = document.getElementById('turn-display');
            if(isMine) {
                el.innerText = "YOUR TURN";
                el.style.color = "var(--green)";
            } else {
                el.innerText = "ENEMY TURN";
                el.style.color = "var(--red)";
            }
        }

        // --- HELPERS ---
        function createGrid(id, prefix, clickHandler) {
            const el = document.getElementById(id);
            el.innerHTML = '';
            rows.forEach(r => {
                for(let c=1; c<=cols; c++) {
                    let d = document.createElement('div');
                    d.className = 'cell';
                    d.id = `${prefix}-${r}${c}`;
                    d.dataset.id = `${prefix}-${r}${c}`;
                    d.innerText = `${r}${c}`;
                    if(clickHandler) d.onclick = () => clickHandler(r, c);
                    el.appendChild(d);
                }
            });
        }

        function getCoords(r, c, size) {
            let res = [];
            let rIdx = rows.indexOf(r);
            for(let i=0; i<size; i++) {
                if(isHorizontal) {
                    if(c + i > cols) return null;
                    res.push(`${r}${c+i}`);
                } else {
                    if(rIdx + i >= rows.length) return null;
                    res.push(`${rows[rIdx+i]}${c}`);
                }
            }
            return res;
        }

        function showOverlay(main, sub, statusClass, duration = 1500) {
            const ol = document.getElementById('anim-overlay');
            const m = document.getElementById('anim-main');
            const s = document.getElementById('anim-sub');
            
            m.innerText = main;
            s.innerText = sub;
            s.className = `overlay-status ${statusClass}`;
            
            ol.classList.add('active');
            setTimeout(() => ol.classList.remove('active'), duration);
        }

        function setTab(view) {
            document.querySelectorAll('.game-view').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            
            document.getElementById(`view-${view}`).classList.add('active');
            document.getElementById(`btn-${view}`).classList.add('active');
        }

        function toggleAxis() {
            isHorizontal = !isHorizontal;
            document.getElementById('axis-display').innerText = isHorizontal ? "HORIZ" : "VERT";
        }

        function resetSetup() {
            myShips = [];
            currentShipIdx = 0;
            document.querySelectorAll('.cell.occupied').forEach(c => c.classList.remove('occupied'));
            updateSetupUI();
        }

        function updateConnStatus(online) {
            const el = document.getElementById('conn-status');
            if(online) {
                el.innerText = "ONLINE";
                el.className = "status-badge connected";
            } else {
                el.innerText = "OFFLINE";
                el.className = "status-badge disconnected";
            }
        }
        
        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>
