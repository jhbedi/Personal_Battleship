<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE BATTLESHIP</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #0f0d0b; --accent: #7c1510; --cream: #e2d6c7; 
            --green: #2ecc71; --red: #e74c3c; --blue: #3498db; 
            --yellow: #f1c40f; 
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); color: var(--cream); font-family: 'Montserrat', sans-serif; 
            margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; height: 100vh;
            overflow: hidden; 
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            transition: background 0.2s;
        }

        /* --- TYPOGRAPHY RESTORATION --- */
        h1, h2, h3, button, .big-text { font-family: 'Oswald', sans-serif; text-transform: uppercase; }
        
        button { cursor: pointer; font-weight: bold; letter-spacing: 1px; }

        /* SCREENS */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; padding: 10px; z-index: 10; }
        .screen.active { display: flex; }

        /* LOBBY */
        .card { 
            background: rgba(255,255,255,0.05); padding: 30px; border: 1px solid rgba(255,255,255,0.1); 
            width: 100%; max-width: 400px; text-align: center; border-radius: 8px; margin-top: 15vh;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        input { 
            background: #222; border: 1px solid #444; color: white; padding: 15px; width: 100%; 
            margin: 10px 0; font-family: 'Montserrat', sans-serif; text-align: center; font-size: 1.2rem; 
        }
        .big-btn { 
            width: 100%; padding: 15px; background: var(--accent); color: white; border: none; 
            font-size: 1.5rem; margin-top: 10px; border-radius: 4px; transition: 0.2s; 
        }
        .big-btn:active { transform: scale(0.98); }
        .big-btn:disabled { background: #333; color: #777; cursor: not-allowed; }

        /* --- SMART GRID FITTING --- */
        .game-view { display: none; width: 100%; flex-direction: column; align-items: center; flex: 1; height: 100%; }
        .game-view.active { display: flex; }

        .grid-wrapper {
            flex: 1; width: 100%; display: flex; align-items: center; justify-content: center;
            padding: 5px; overflow: hidden; min-height: 0;
        }

        .grid { 
            display: grid; grid-template-columns: repeat(12, 1fr); gap: 2px; 
            width: 100%; height: 100%; max-width: 100%; max-height: 100%; aspect-ratio: 1;
        }

        .cell { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            display: flex; align-items: center; justify-content: center; 
            font-size: clamp(8px, 1.5vmin, 16px); color: #555; position: relative; 
            font-family: 'Oswald', sans-serif; transition: 0.2s;
        }

        /* CELL STATES */
        .cell.occupied { background: #555 !important; border-color: #777; color: #fff; }
        .cell.preview { background: #333 !important; border: 1px dashed #999; }
        
        /* Radar */
        .radar .cell:active { background: rgba(231, 76, 60, 0.3); }
        .radar .cell.hit { background: var(--red) !important; color: white; border: 1px solid white; box-shadow: 0 0 10px var(--red); z-index: 5; }
        .radar .cell.miss { background: var(--green) !important; opacity: 0.4; color: black; }
        .radar .cell.pending { background: var(--yellow) !important; animation: pulse 0.5s infinite; }

        /* Fleet */
        .fleet .cell.my-ship { background: #444; border: 1px solid #666; }
        .fleet .cell.hit { background: var(--red) !important; border: 2px solid white; z-index: 2; }
        .fleet .cell.miss { background: var(--blue) !important; opacity: 0.3; }

        /* HUD & TABS */
        .hud { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 2px solid var(--accent); margin-bottom: 5px; flex-shrink: 0; background: rgba(0,0,0,0.5); }
        .tab-controls { display: flex; width: 100%; max-width: 600px; gap: 5px; padding: 5px; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 15px; background: #222; color: #666; border: 1px solid #333; font-size: 1.2rem; font-family: 'Oswald', sans-serif; }
        .tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        /* COPY BOX */
        .id-box {
            font-size: 2rem; font-family: 'Oswald', sans-serif; color: var(--green); 
            border: 2px dashed #555; padding: 20px; margin: 15px 0; 
            cursor: pointer; user-select: text; transition: 0.3s;
        }
        .id-box:hover { background: rgba(46, 204, 113, 0.1); border-color: var(--green); }

        /* --- CINEMATIC ANIMATION OVERLAY --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .overlay.active { opacity: 1; }
        
        .overlay-coord { 
            font-family: 'Oswald', sans-serif; font-size: 25vw; font-weight: 700; 
            color: var(--cream); line-height: 0.8; text-shadow: 0 0 30px rgba(255,255,255,0.1);
        }
        .overlay-status { 
            font-family: 'Oswald', sans-serif; font-size: 6vw; text-transform: uppercase; 
            margin-top: 20px; letter-spacing: 5px; text-align: center; 
        }
        
        .status-hit { color: var(--red); text-shadow: 0 0 50px var(--red); }
        .status-miss { color: var(--blue); text-shadow: 0 0 20px var(--blue); }
        .status-sunk { color: var(--red); border: 10px solid var(--red); padding: 20px 40px; background: black; text-shadow: 0 0 30px red; }
        .status-win { color: var(--green); text-shadow: 0 0 50px var(--green); }
        
        /* Flash Screen on Hit */
        body.damage-flash .overlay { background: rgba(180, 0, 0, 0.95); }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="overlay" id="anim-overlay">
        <div class="overlay-coord" id="anim-main"></div>
        <div class="overlay-status" id="anim-sub"></div>
    </div>

    <div id="screen-lobby" class="screen active">
        <h1 style="font-size: 4rem; color: var(--accent); margin-bottom: 0;">BATTLESHIP</h1>
        <div style="font-size: 1rem; color: #666; letter-spacing: 3px; margin-bottom: 20px;">TACTICAL P2P WARFARE</div>
        <div class="card">
            <h3>Start Mission</h3>
            <button class="big-btn" onclick="hostGame()">Create Room</button>
            <div style="margin: 20px; color: #666; font-family: 'Oswald', sans-serif;">- OR -</div>
            <h3>Join Crew</h3>
            <input type="text" id="join-id" placeholder="ENTER ROOM ID">
            <button class="big-btn" onclick="joinGame()">Connect</button>
        </div>
    </div>

    <div id="screen-wait" class="screen">
        <h1 style="margin-top: 20vh;">UPLINK READY</h1>
        <div class="card">
            <p style="color:#888;">CLICK TO COPY CODE:</p>
            <div id="host-id-display" class="id-box" onclick="copyId()">Generating...</div>
            <div id="wait-msg">WAITING FOR OPPONENT...</div>
        </div>
    </div>

    <div id="screen-setup" class="screen">
        <div class="hud">
            <span>DEPLOY: <strong id="ship-name-display" style="color:var(--yellow)">...</strong></span>
            <button onclick="resetSetup()" style="background:transparent; border:1px solid #555; color:#888; padding:5px 10px; font-family:'Oswald';">RESET</button>
        </div>
        
        <div class="grid-wrapper">
            <div class="grid" id="setup-grid"></div>
        </div>

        <div style="width:100%; max-width:600px; display:flex; gap:10px; margin-bottom: 10px; flex-shrink: 0;">
            <button class="big-btn" style="flex:1; background:#444;" onclick="toggleAxis()">Rotate: <span id="axis-display">HORIZ</span></button>
            <button class="big-btn" style="flex:1; display:none; background:var(--green); color:black;" id="confirm-btn" onclick="finalizeSetup()">CONFIRM</button>
        </div>
        <div id="setup-msg" style="color: #666; font-size: 0.8rem; margin-bottom: 5px;">TAP GRID TO PLACE SHIP</div>
    </div>

    <div id="screen-game" class="screen">
        <div class="hud">
            <div id="conn-status" style="color:var(--green); font-weight:bold;">‚óè ONLINE</div>
            <div id="turn-display" style="font-size: 1.2rem; letter-spacing: 1px;">WAITING...</div>
        </div>

        <div class="tab-controls">
            <button class="tab-btn active" onclick="setTab('radar')" id="btn-radar">RADAR</button>
            <button class="tab-btn" onclick="setTab('fleet')" id="btn-fleet">FLEET</button>
        </div>

        <div class="game-view active" id="view-radar">
            <div class="grid-wrapper">
                <div class="grid radar" id="radar-grid"></div>
            </div>
            <div style="text-align:center; color:#666; margin:5px; font-size: 0.8rem;">TAP ENEMY SECTOR TO FIRE</div>
        </div>

        <div class="game-view" id="view-fleet">
            <div class="grid-wrapper">
                <div class="grid fleet" id="fleet-grid"></div>
            </div>
            <div style="text-align:center; color:#666; margin:5px; font-size: 0.8rem;">DEFENSIVE MONITORING</div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const SHIP_DATA = [
            { name: "THE PROFESSOR", size: 5 },
            { name: "BERLIN", size: 4 },
            { name: "TOKYO", size: 3 },
            { name: "NAIROBI", size: 3 },
            { name: "RIO", size: 2 }
        ];

        let peer, conn, mySide, myTurn = false, isConnected = false, heartbeatInterval;
        let currentShipIdx = 0, isHorizontal = true, myShips = [], totalMyShipsLost = 0;
        let amIReady = false, opponentReady = false;
        const rows = ['A','B','C','D','E','F','G','H'];
        const cols = 12;

        // --- COPY ID ---
        function copyId() {
            const el = document.getElementById('host-id-display');
            if(el.innerText === 'Generating...') return;
            const textToCopy = el.getAttribute('data-raw-id') || el.innerText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const original = el.innerText;
                el.innerText = "COPIED!";
                el.style.color = "white";
                el.style.borderColor = "white";
                setTimeout(() => {
                    el.innerText = original;
                    el.style.color = "var(--green)";
                    el.style.borderColor = "#555";
                }, 1500);
            });
        }

        // --- NETWORK ---
        function initPeer(id = null) {
            peer = new Peer(id);
            peer.on('open', (id) => {
                if(mySide === 'host') {
                    const disp = document.getElementById('host-id-display');
                    disp.innerText = id;
                    disp.setAttribute('data-raw-id', id);
                    switchScreen('screen-wait');
                }
            });
            peer.on('connection', (c) => handleConnection(c));
            peer.on('error', (err) => alert("Net Error: " + err));
        }

        function handleConnection(c) {
            if(conn) conn.close();
            conn = c;
            conn.on('open', () => {
                isConnected = true;
                startHeartbeat();
                if(document.getElementById('screen-lobby').classList.contains('active') || 
                   document.getElementById('screen-wait').classList.contains('active')) {
                    switchScreen('screen-setup');
                    initSetupGrid();
                }
            });
            conn.on('data', (data) => handleData(data));
            conn.on('close', () => { isConnected = false; alert("Opponent Disconnected"); });
        }

        function startHeartbeat() {
            if(heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(() => { if(conn && conn.open) conn.send({ type: 'PING' }); }, 2000);
        }

        function hostGame() { mySide = 'host'; myTurn = true; initPeer(); }
        function joinGame() { 
            const id = document.getElementById('join-id').value.trim();
            if(!id) return alert("Enter ID");
            mySide = 'client'; myTurn = false; 
            peer = new Peer(); 
            peer.on('open', () => handleConnection(peer.connect(id)));
        }

        function send(payload) { if(conn && conn.open) conn.send(payload); }

        function handleData(data) {
            if(data.type === 'PING') return;
            
            if(data.type === 'READY') {
                opponentReady = true;
                const msg = document.getElementById('setup-msg');
                msg.innerText = "OPPONENT IS READY.";
                msg.style.color = "var(--green)";
                if(mySide === 'host') tryStartGame();
            }
            if(data.type === 'START') initGameUI();
            if(data.type === 'FIRE') processIncomingAttack(data.coord);
            if(data.type === 'RESULT') processAttackResult(data);
            if(data.type === 'GAMEOVER') showOverlay("VICTORY", "ENEMY FLEET ELIMINATED", "status-win", 10000);
        }

        // --- GAME LOGIC ---
        function processIncomingAttack(coord) {
            let hitShip = null, isSunk = false;
            for(let ship of myShips) {
                if(ship.coords.includes(coord)) {
                    ship.hits++; hitShip = ship;
                    if(ship.hits === ship.size) { isSunk = true; totalMyShipsLost++; }
                    break;
                }
            }

            const result = hitShip ? 'hit' : 'miss';
            const msg = isSunk ? `SUNK: ${hitShip.name}` : (hitShip ? "IMPACT!" : "SAFE");
            
            showOverlay(coord, msg, hitShip ? (isSunk ? "status-sunk" : "status-hit") : "status-miss");
            const cell = document.getElementById(`fleet-${coord}`);
            if(cell) cell.classList.add(result);

            send({ type: 'RESULT', coord: coord, hit: !!hitShip, sunkName: isSunk ? hitShip.name : null });

            if(totalMyShipsLost === SHIP_DATA.length) {
                setTimeout(() => { send({ type: 'GAMEOVER' }); showOverlay("DEFEAT", "FLEET DESTROYED", "status-hit", 10000); }, 2000);
            }
            setTurn(true);
        }

        function processAttackResult(data) {
            const cell = document.getElementById(`radar-${data.coord}`);
            cell.classList.remove('pending');
            cell.classList.add(data.hit ? 'hit' : 'miss');
            if(data.sunkName) showOverlay("DESTROYED", data.sunkName, "status-sunk", 3000);
            else showOverlay(data.coord, data.hit ? "DIRECT HIT" : "MISSED", data.hit ? "status-hit" : "status-miss");
        }

        // --- SETUP ---
        function initSetupGrid() { 
            createGrid('setup-grid', 'setup', (r, c) => placeShip(r, c), (r,c,e) => handleHover(r,c,e)); 
            updateSetupUI(); 
        }

        function handleHover(r, c, isEntering) {
            document.querySelectorAll('.cell.preview').forEach(el => el.classList.remove('preview'));
            if(!isEntering || currentShipIdx >= SHIP_DATA.length) return;
            const shipInfo = SHIP_DATA[currentShipIdx];
            const coords = getCoords(r, c, shipInfo.size);
            if(coords) {
                coords.forEach(co => {
                    const cell = document.getElementById(`setup-${co}`);
                    if(cell && !cell.classList.contains('occupied')) cell.classList.add('preview');
                });
            }
        }

        function placeShip(r, c) {
            if(currentShipIdx >= SHIP_DATA.length) return;
            const shipInfo = SHIP_DATA[currentShipIdx];
            const coords = getCoords(r, c, shipInfo.size);
            if(!coords) return;
            for(let existing of myShips) {
                for(let co of coords) if(existing.coords.includes(co)) return alert("Overlap!");
            }
            myShips.push({ name: shipInfo.name, size: shipInfo.size, coords: coords, hits: 0 });
            coords.forEach(co => document.querySelector(`.cell[data-id="setup-${co}"]`).classList.add('occupied'));
            currentShipIdx++; updateSetupUI();
        }

        function updateSetupUI() {
            if(currentShipIdx < SHIP_DATA.length) {
                document.getElementById('ship-name-display').innerText = SHIP_DATA[currentShipIdx].name + ` (${SHIP_DATA[currentShipIdx].size})`;
            } else {
                document.getElementById('ship-name-display').innerText = "FLEET READY";
                document.getElementById('confirm-btn').style.display = 'block';
            }
        }

        function finalizeSetup() {
            amIReady = true;
            const btn = document.getElementById('confirm-btn');
            btn.innerText = "WAITING FOR OPPONENT...";
            btn.disabled = true;
            send({ type: 'READY' });
            if(mySide === 'host') tryStartGame();
            else document.getElementById('setup-msg').innerText = "Waiting for host to launch...";
        }

        function tryStartGame() {
            if(amIReady && opponentReady) {
                send({ type: 'START' }); 
                initGameUI();
            }
        }

        // --- UI UTILS ---
        function initGameUI() {
            switchScreen('screen-game');
            createGrid('radar-grid', 'radar', (r, c) => handleFire(r, c));
            createGrid('fleet-grid', 'fleet', null);
            myShips.forEach(ship => ship.coords.forEach(co => document.getElementById(`fleet-${co}`).classList.add('my-ship')));
            setTurn(myTurn);
        }

        function handleFire(r, c) {
            if(!myTurn) return;
            const coord = `${r}${c}`;
            const cell = document.getElementById(`radar-${coord}`);
            if(cell.classList.contains('hit') || cell.classList.contains('miss') || cell.classList.contains('pending')) return;
            cell.classList.add('pending');
            setTurn(false);
            send({ type: 'FIRE', coord: coord });
        }

        function setTurn(isMine) {
            myTurn = isMine;
            const el = document.getElementById('turn-display');
            if(isMine) { el.innerText = "YOUR TURN"; el.style.color = "var(--green)"; }
            else { el.innerText = "ENEMY TURN"; el.style.color = "var(--red)"; }
        }

        function createGrid(id, prefix, clickHandler, hoverHandler) {
            const el = document.getElementById(id);
            el.innerHTML = '';
            rows.forEach(r => {
                for(let c=1; c<=cols; c++) {
                    let d = document.createElement('div');
                    d.className = 'cell'; d.id = `${prefix}-${r}${c}`; d.dataset.id = `${prefix}-${r}${c}`;
                    d.innerText = `${r}${c}`;
                    if(clickHandler) d.onclick = () => clickHandler(r, c);
                    if(hoverHandler) {
                        d.onmouseenter = () => hoverHandler(r, c, true);
                        d.onmouseleave = () => hoverHandler(r, c, false);
                    }
                    el.appendChild(d);
                }
            });
        }

        function getCoords(r, c, size) {
            let res = [];
            let rIdx = rows.indexOf(r);
            for(let i=0; i<size; i++) {
                if(isHorizontal) { if(c + i > cols) return null; res.push(`${r}${c+i}`); }
                else { if(rIdx + i >= rows.length) return null; res.push(`${rows[rIdx+i]}${c}`); }
            }
            return res;
        }

        function showOverlay(main, sub, statusClass, duration = 1500) {
            const ol = document.getElementById('anim-overlay');
            document.getElementById('anim-main').innerText = main;
            const s = document.getElementById('anim-sub');
            s.innerText = sub; s.className = `overlay-status ${statusClass}`;
            
            // Screen Flash Logic
            if(statusClass === 'status-hit' || statusClass === 'status-sunk') {
                document.body.classList.add('damage-flash');
            }

            ol.classList.add('active');
            setTimeout(() => {
                ol.classList.remove('active');
                document.body.classList.remove('damage-flash');
            }, duration);
        }

        function setTab(view) {
            document.querySelectorAll('.game-view').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(`view-${view}`).classList.add('active');
            document.getElementById(`btn-${view}`).classList.add('active');
        }

        function toggleAxis() {
            isHorizontal = !isHorizontal;
            document.getElementById('axis-display').innerText = isHorizontal ? "HORIZ" : "VERT";
        }
        function resetSetup() {
            myShips = []; currentShipIdx = 0; amIReady = false;
            document.querySelectorAll('.cell.occupied').forEach(c => c.classList.remove('occupied'));
            updateSetupUI();
        }
        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>
