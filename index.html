<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE BATTLESHIP: HEIST EDITION</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #0f0d0b; --accent: #7c1510; --cream: #e2d6c7; 
            --green: #27ae60; --red: #c0392b; --blue: #2980b9; 
            --yellow: #f39c12; 
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); color: var(--cream); font-family: 'Montserrat', sans-serif; 
            margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; width: 100vw;
            overflow: hidden; 
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        h1, h2, h3, button { font-family: 'Oswald', sans-serif; text-transform: uppercase; }
        button { cursor: pointer; font-weight: bold; letter-spacing: 1px; }

        /* --- SCREENS --- */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; padding: 15px; z-index: 10; }
        .screen.active { display: flex; }

        /* LOBBY CARD */
        .card { 
            background: rgba(20, 20, 20, 0.9); 
            padding: 30px; border: 1px solid rgba(255,255,255,0.05); 
            width: 100%; max-width: 400px; text-align: center; border-radius: 4px; margin-top: 10vh;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        input { 
            background: #111; border: 1px solid #333; color: var(--cream); padding: 15px; width: 100%; 
            margin: 10px 0; font-family: 'Oswald', sans-serif; text-align: center; font-size: 1.5rem; 
            letter-spacing: 2px; text-transform: uppercase; border-radius: 2px;
        }
        input:focus { outline: none; border-color: var(--accent); }

        .big-btn { 
            width: 100%; padding: 15px; background: var(--accent); color: white; border: none; 
            font-size: 1.2rem; margin-top: 10px; border-radius: 2px; transition: 0.2s; 
        }
        .big-btn:active { transform: scale(0.98); }
        .big-btn:disabled { background: #333; color: #777; cursor: not-allowed; }

        /* --- RESPONSIVE GRID LAYOUT --- */
        .game-view { display: none; width: 100%; flex-direction: column; align-items: center; flex: 1; height: 100%; min-height: 0; }
        .game-view.active { display: flex; }

        .grid-wrapper {
            flex: 1; width: 100%; display: flex; align-items: center; justify-content: center;
            padding: 10px; overflow: hidden; min-height: 0; position: relative;
        }

        .grid { 
            display: grid; grid-template-columns: repeat(12, 1fr); gap: 2px; 
            width: 100%; height: 100%; 
            max-width: 100%; max-height: 100%; 
            aspect-ratio: 1/1;
        }

        .cell { 
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); 
            display: flex; align-items: center; justify-content: center; 
            font-size: clamp(8px, 1.5vmin, 14px); color: #444; position: relative; 
            font-family: 'Oswald', sans-serif; transition: 0.1s; border-radius: 2px;
        }

        /* --- CLEANER STATES --- */
        .cell.occupied { background: #444 !important; border: 1px solid #666; }
        .cell.preview { background: #333 !important; border: 1px dashed var(--yellow); opacity: 0.8; }

        .cell.my-ship { 
            background: #444 !important; 
            border: 1px solid #777; 
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }

        .cell.hit { 
            background: var(--red) !important; color: white; 
            border: 1px solid rgba(255,255,255,0.5); z-index: 2;
        }

        .cell.miss { 
            background: rgba(46, 204, 113, 0.15) !important; color: transparent; 
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        .cell.miss::after {
            content: ''; width: 6px; height: 6px; background: var(--green); border-radius: 50%; opacity: 0.5;
        }

        .cell.pending { 
            background: rgba(241, 196, 15, 0.2) !important; border: 1px dashed var(--yellow);
        }

        /* --- HUD --- */
        .hud { 
            width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 5px; flex-shrink: 0; 
            background: #151515; border-radius: 4px;
        }
        
        .tab-controls { display: flex; width: 100%; max-width: 600px; gap: 5px; padding: 5px; flex-shrink: 0; }
        .tab-btn { 
            flex: 1; padding: 12px; background: #1a1a1a; color: #666; 
            border: 1px solid #333; font-size: 1rem; border-radius: 2px; transition: 0.2s;
        }
        .tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        .id-box {
            font-size: 2rem; font-family: 'Oswald', sans-serif; color: var(--green); 
            border: 1px solid #333; padding: 20px; margin: 15px 0; border-radius: 4px;
            cursor: pointer; user-select: text; transition: 0.2s; background: #111;
        }
        .id-box:hover { background: #1a1a1a; border-color: var(--green); }

        /* --- OVERLAY --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .overlay.active { opacity: 1; pointer-events: auto; }
        
        .overlay-coord { 
            font-family: 'Oswald', sans-serif; font-size: 20vw; font-weight: 700; 
            color: #eee; line-height: 0.8; 
        }
        .overlay-status { 
            font-family: 'Oswald', sans-serif; font-size: 8vw; text-transform: uppercase; 
            margin-top: 10px; letter-spacing: 2px; text-align: center; font-weight: bold;
        }
        
        .status-hit { color: var(--red); }
        .status-miss { color: var(--blue); }
        
        /* VICTORY/DEFEAT PERMANENT SCREEN */
        .status-win { 
            color: var(--yellow); font-size: 10vw; 
            animation: victory-scale 0.8s ease-out forwards;
        }

        .status-sunk {
            color: var(--red); font-size: 8vw; border: 4px solid var(--red); padding: 10px 30px;
            background: rgba(0,0,0,0.9); transform: rotate(-5deg);
        }

        .restart-btn {
            margin-top: 30px; padding: 15px 30px; background: transparent; 
            border: 1px solid #555; color: #fff; font-size: 1.2rem; display: none; cursor: pointer;
        }
        .restart-btn.visible { display: block; }
        .restart-btn:hover { background: white; color: black; }

        /* Screen Flash for Damage */
        body.damage-flash::after {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 50%, rgba(192, 57, 43, 0.4) 100%);
            pointer-events: none; z-index: 9998; animation: flash-fade 0.5s forwards;
        }

        @keyframes victory-scale { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes flash-fade { 0% { opacity: 1; } 100% { opacity: 0; } }

    </style>
</head>
<body>

    <!-- ANIMATION LAYER -->
    <div class="overlay" id="anim-overlay">
        <div class="overlay-coord" id="anim-main"></div>
        <div class="overlay-status" id="anim-sub"></div>
        <button class="restart-btn" id="restart-btn" onclick="location.reload()">RELOAD TO PLAY AGAIN</button>
    </div>

    <!-- 1. LOBBY -->
    <div id="screen-lobby" class="screen active">
        <h1 style="font-size: 4rem; color: var(--accent); margin-bottom: 0;">BATTLESHIP</h1>
        <div style="font-size: 0.9rem; color: #666; letter-spacing: 4px; margin-bottom: 20px;">TACTICAL P2P WARFARE</div>
        
        <div class="card">
            <h3 style="color: var(--cream);">Start Mission</h3>
            <button class="big-btn" onclick="hostGame()">Create Room</button>
            <div style="margin: 20px; color: #444; font-size: 0.8rem;">— OR JOIN CREW —</div>
            <input type="text" id="join-id" placeholder="ENTER ID">
            <button class="big-btn" id="join-btn" onclick="joinGame()">Connect</button>
        </div>
    </div>

    <!-- 2. WAITING ROOM -->
    <div id="screen-wait" class="screen">
        <h1 style="margin-top: 15vh; color: var(--green);">UPLINK READY</h1>
        <div class="card">
            <p style="color:#888; font-size: 0.9rem;">TAP BOX TO COPY CODE:</p>
            <div id="host-id-display" class="id-box" onclick="copyId()">Generating...</div>
            <div id="wait-msg">WAITING FOR OPPONENT...</div>
        </div>
    </div>

    <!-- 3. SETUP -->
    <div id="screen-setup" class="screen">
        <div class="hud">
            <div>DEPLOY: <strong id="ship-name-display" style="color:var(--yellow); font-size: 1.2rem;">...</strong></div>
            <button onclick="resetSetup()" style="background:transparent; border:1px solid #555; color:#888; padding:5px 10px; font-size: 0.8rem;">RESET</button>
        </div>
        
        <div class="grid-wrapper">
            <div class="grid" id="setup-grid"></div>
        </div>

        <div style="width:100%; max-width:600px; display:flex; gap:10px; margin-bottom: 10px; flex-shrink: 0;">
            <button class="big-btn" style="flex:1; background:#333; font-size: 1rem;" onclick="toggleAxis()">Rotate: <span id="axis-display" style="color:var(--yellow)">HORIZ</span></button>
            <button class="big-btn" style="flex:1; display:none; background:var(--green); color:black;" id="confirm-btn" onclick="finalizeSetup()">CONFIRM</button>
        </div>
        <div id="setup-msg" style="color: #666; font-size: 0.8rem; margin-bottom: 5px; text-transform: uppercase;">Tap grid to position fleet</div>
    </div>

    <!-- 4. GAMEPLAY -->
    <div id="screen-game" class="screen">
        <div class="hud">
            <div id="conn-status" style="color:var(--green); font-weight:bold; font-size: 0.9rem;">● SECURE LINK</div>
            <div id="turn-display" style="font-size: 1.2rem; letter-spacing: 1px;">WAITING...</div>
        </div>

        <div class="tab-controls">
            <button class="tab-btn active" onclick="setTab('radar')" id="btn-radar">RADAR (ATTACK)</button>
            <button class="tab-btn" onclick="setTab('fleet')" id="btn-fleet">FLEET (DEFEND)</button>
        </div>

        <!-- RADAR VIEW -->
        <div class="game-view active" id="view-radar">
            <div class="grid-wrapper">
                <div class="grid radar" id="radar-grid"></div>
            </div>
            <div style="text-align:center; color:#555; margin:5px; font-size: 0.7rem; letter-spacing: 1px;">TAP ENEMY SECTOR TO FIRE</div>
        </div>

        <!-- FLEET VIEW -->
        <div class="game-view" id="view-fleet">
            <div class="grid-wrapper">
                <div class="grid fleet" id="fleet-grid"></div>
            </div>
            <div style="text-align:center; color:#555; margin:5px; font-size: 0.7rem; letter-spacing: 1px;">MONITORING HULL INTEGRITY</div>
        </div>
    </div>

    <script>
        const SHIP_DATA = [
            { name: "THE PROFESSOR", size: 5 }, { name: "BERLIN", size: 4 },
            { name: "TOKYO", size: 3 }, { name: "NAIROBI", size: 3 }, { name: "RIO", size: 2 }
        ];

        let peer, conn, mySide, myTurn = false, isConnected = false, heartbeatInterval;
        let currentShipIdx = 0, isHorizontal = true, myShips = [], totalMyShipsLost = 0;
        let amIReady = false, opponentReady = false;
        let overlayTimeout;
        let gameEnded = false;
        let connectionRetries = 0; // Retry counter

        const rows = ['A','B','C','D','E','F','G','H'];
        const cols = 12;

        // --- NETWORKING CONFIGURATION ---
        // Enhanced ICE Servers to penetrate NAT/Firewalls
        const PEER_CONFIG = {
            debug: 2,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ],
                iceCandidatePoolSize: 10,
            }
        };

        function copyId() {
            const el = document.getElementById('host-id-display');
            if(el.innerText === 'Generating...') return;
            const textToCopy = el.innerText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const original = el.innerText;
                el.innerText = "COPIED!"; el.style.color = "white"; el.style.borderColor = "white";
                setTimeout(() => { el.innerText = original; el.style.color = "var(--green)"; el.style.borderColor = "#333"; }, 1500);
            });
        }

        // --- CONNECTION LOGIC ---
        function initPeer(customId = null) {
            if(mySide === 'host' && !customId) customId = 'HEIST-' + Math.floor(1000 + Math.random() * 9000);

            peer = new Peer(customId, PEER_CONFIG);

            peer.on('open', (id) => {
                if(mySide === 'host') {
                    document.getElementById('host-id-display').innerText = id;
                    switchScreen('screen-wait');
                }
            });

            peer.on('connection', (c) => handleConnection(c));
            
            peer.on('error', (err) => {
                console.error(err);
                if(err.type === 'peer-unavailable') { alert("ID not found. Check ID or try again (User might be on different network type)."); resetJoinButton(); }
                else if (err.type === 'unavailable-id') { initPeer(); } 
                else { alert("Connection Error: " + err.type); resetJoinButton(); }
            });
        }

        function handleConnection(c) {
            if(conn) conn.close();
            conn = c;
            conn.on('open', () => {
                isConnected = true;
                startHeartbeat();
                if(document.getElementById('screen-lobby').classList.contains('active') || 
                   document.getElementById('screen-wait').classList.contains('active')) {
                    switchScreen('screen-setup');
                    initSetupGrid();
                }
            });
            conn.on('data', (data) => handleData(data));
            conn.on('close', () => { 
                isConnected = false; alert("Connection Lost. Opponent Disconnected."); location.reload(); 
            });
        }

        function startHeartbeat() {
            if(heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(() => { if(conn && conn.open) conn.send({ type: 'PING' }); }, 2000);
        }

        function hostGame() { mySide = 'host'; myTurn = true; initPeer(); }

        function joinGame() { 
            const input = document.getElementById('join-id');
            const btn = document.getElementById('join-btn');
            const id = input.value.trim().toUpperCase();
            if(!id) return alert("Enter ID");
            
            btn.disabled = true;
            mySide = 'client'; myTurn = false; 
            connectionRetries = 0;
            
            attemptConnection(id, btn);
        }

        function attemptConnection(id, btn) {
            connectionRetries++;
            btn.innerText = `SEARCHING... (${connectionRetries}/3)`;
            
            // Destroy old peer instance if retrying
            if(peer) peer.destroy();

            peer = new Peer(null, PEER_CONFIG); 
            
            peer.on('open', () => {
                btn.innerText = "NEGOTIATING...";
                const c = peer.connect(id, { reliable: true });
                
                // If connection opens, great.
                handleConnection(c);
                
                // If it takes too long, retry or fail.
                setTimeout(() => { 
                    if(!isConnected) {
                        if(connectionRetries < 3) {
                            console.log("Retrying connection...");
                            attemptConnection(id, btn);
                        } else {
                            alert("Connection Failed. Firewall likely blocking P2P. Try using the same WiFi or Mobile Hotspot."); 
                            resetJoinButton(); 
                        }
                    } 
                }, 15000); // 15s Timeout per attempt
            });

            peer.on('error', (err) => {
                console.log("Peer Error:", err);
                // If peer unavailable, fail immediately
                if(err.type === 'peer-unavailable') {
                    alert("Player ID not found. They might be offline.");
                    resetJoinButton();
                }
            });
        }

        function resetJoinButton() {
            const btn = document.getElementById('join-btn');
            btn.innerText = "CONNECT"; btn.disabled = false;
        }

        function send(payload) { if(conn && conn.open) conn.send(payload); }

        function handleData(data) {
            if(data.type === 'PING') return;
            if(data.type === 'READY') {
                opponentReady = true;
                const msg = document.getElementById('setup-msg');
                msg.innerText = "OPPONENT IS READY."; msg.style.color = "var(--green)";
                if(mySide === 'host') tryStartGame();
            }
            if(data.type === 'START') initGameUI();
            if(data.type === 'FIRE') processIncomingAttack(data.coord);
            if(data.type === 'RESULT') processAttackResult(data);
            
            if(data.type === 'GAMEOVER') {
                gameEnded = true; 
                showOverlay("VICTORY", "THE HEIST IS SUCCESSFUL", "status-win", 0);
            }
        }

        // --- GAME LOGIC ---
        function processIncomingAttack(coord) {
            let hitShip = null, isSunk = false;
            for(let ship of myShips) {
                if(ship.coords.includes(coord)) {
                    ship.hits++; hitShip = ship;
                    if(ship.hits === ship.size) { isSunk = true; totalMyShipsLost++; }
                    break;
                }
            }
            const result = hitShip ? 'hit' : 'miss';
            const msg = isSunk ? `${hitShip.name}` : (hitShip ? "IMPACT!" : "SAFE");
            const status = hitShip ? (isSunk ? "status-sunk" : "status-hit") : "status-miss";
            
            showOverlay(coord, msg, status);
            
            const cell = document.getElementById(`fleet-${coord}`);
            if(cell) cell.classList.add(result);

            send({ type: 'RESULT', coord: coord, hit: !!hitShip, sunkName: isSunk ? hitShip.name : null });

            if(totalMyShipsLost === SHIP_DATA.length) {
                gameEnded = true; 
                setTimeout(() => { 
                    send({ type: 'GAMEOVER' }); 
                    showOverlay("DEFEAT", "FLEET DESTROYED", "status-hit", 0); 
                }, 2000);
            }
            setTurn(true);
        }

        function processAttackResult(data) {
            const cell = document.getElementById(`radar-${data.coord}`);
            cell.classList.remove('pending');
            cell.classList.add(data.hit ? 'hit' : 'miss');
            if(data.sunkName) showOverlay("DESTROYED", data.sunkName, "status-sunk", 3000);
            else showOverlay(data.coord, data.hit ? "DIRECT HIT" : "MISSED", data.hit ? "status-hit" : "status-miss");
        }

        // --- SETUP ---
        function initSetupGrid() { 
            createGrid('setup-grid', 'setup', (r, c) => placeShip(r, c), (r,c,e) => handleHover(r,c,e)); 
            updateSetupUI(); 
        }

        function handleHover(r, c, isEntering) {
            document.querySelectorAll('.cell.preview').forEach(el => el.classList.remove('preview'));
            if(!isEntering || currentShipIdx >= SHIP_DATA.length) return;
            const shipInfo = SHIP_DATA[currentShipIdx];
            const coords = getCoords(r, c, shipInfo.size);
            if(coords) {
                coords.forEach(co => {
                    const cell = document.getElementById(`setup-${co}`);
                    if(cell && !cell.classList.contains('occupied')) cell.classList.add('preview');
                });
            }
        }

        function placeShip(r, c) {
            if(currentShipIdx >= SHIP_DATA.length) return;
            const shipInfo = SHIP_DATA[currentShipIdx];
            const coords = getCoords(r, c, shipInfo.size);
            if(!coords) return;
            for(let existing of myShips) {
                for(let co of coords) if(existing.coords.includes(co)) return alert("Overlap!");
            }
            myShips.push({ name: shipInfo.name, size: shipInfo.size, coords: coords, hits: 0 });
            coords.forEach(co => document.querySelector(`.cell[data-id="setup-${co}"]`).classList.add('occupied'));
            currentShipIdx++; updateSetupUI();
        }

        function updateSetupUI() {
            if(currentShipIdx < SHIP_DATA.length) {
                document.getElementById('ship-name-display').innerText = SHIP_DATA[currentShipIdx].name + ` (${SHIP_DATA[currentShipIdx].size})`;
            } else {
                document.getElementById('ship-name-display').innerText = "FLEET READY";
                document.getElementById('confirm-btn').style.display = 'block';
            }
        }

        function finalizeSetup() {
            amIReady = true;
            const btn = document.getElementById('confirm-btn');
            btn.innerText = "WAITING..."; btn.disabled = true;
            send({ type: 'READY' });
            if(mySide === 'host') tryStartGame();
            else document.getElementById('setup-msg').innerText = "Waiting for host to launch...";
        }

        function tryStartGame() {
            if(amIReady && opponentReady) {
                send({ type: 'START' }); 
                initGameUI();
            }
        }

        function initGameUI() {
            switchScreen('screen-game');
            createGrid('radar-grid', 'radar', (r, c) => handleFire(r, c));
            createGrid('fleet-grid', 'fleet', null);
            myShips.forEach(ship => ship.coords.forEach(co => document.getElementById(`fleet-${co}`).classList.add('my-ship')));
            setTurn(myTurn);
        }

        function handleFire(r, c) {
            if(!myTurn) return;
            const coord = `${r}${c}`;
            const cell = document.getElementById(`radar-${coord}`);
            if(cell.classList.contains('hit') || cell.classList.contains('miss') || cell.classList.contains('pending')) return;
            cell.classList.add('pending');
            setTurn(false);
            send({ type: 'FIRE', coord: coord });
        }

        function setTurn(isMine) {
            myTurn = isMine;
            const el = document.getElementById('turn-display');
            if(isMine) { el.innerText = "YOUR TURN"; el.style.color = "var(--green)"; }
            else { el.innerText = "ENEMY TURN"; el.style.color = "var(--red)"; }
        }

        function createGrid(id, prefix, clickHandler, hoverHandler) {
            const el = document.getElementById(id);
            el.innerHTML = '';
            rows.forEach(r => {
                for(let c=1; c<=cols; c++) {
                    let d = document.createElement('div');
                    d.className = 'cell'; d.id = `${prefix}-${r}${c}`; d.dataset.id = `${prefix}-${r}${c}`;
                    d.innerText = `${r}${c}`;
                    if(clickHandler) d.onclick = () => clickHandler(r, c);
                    if(hoverHandler) {
                        d.onmouseenter = () => hoverHandler(r, c, true);
                        d.onmouseleave = () => hoverHandler(r, c, false);
                    }
                    el.appendChild(d);
                }
            });
        }

        function getCoords(r, c, size) {
            let res = [];
            let rIdx = rows.indexOf(r);
            for(let i=0; i<size; i++) {
                if(isHorizontal) { if(c + i > cols) return null; res.push(`${r}${c+i}`); }
                else { if(rIdx + i >= rows.length) return null; res.push(`${rows[rIdx+i]}${c}`); }
            }
            return res;
        }

        function showOverlay(main, sub, statusClass, duration = 1500) {
            if(gameEnded && duration > 0) return;

            const ol = document.getElementById('anim-overlay');
            
            if(overlayTimeout) {
                clearTimeout(overlayTimeout);
                overlayTimeout = null;
            }

            document.getElementById('anim-main').innerText = main;
            const s = document.getElementById('anim-sub');
            s.innerText = sub; s.className = `overlay-status ${statusClass}`;
            
            if (duration === 0) {
                document.getElementById('restart-btn').classList.add('visible');
            } else {
                document.getElementById('restart-btn').classList.remove('visible');
            }

            if(statusClass === 'status-hit' || statusClass === 'status-sunk') {
                document.body.classList.add('damage-flash');
            } else {
                 document.body.classList.remove('damage-flash');
            }

            ol.classList.add('active');
            
            if (duration > 0) {
                overlayTimeout = setTimeout(() => {
                    ol.classList.remove('active');
                    document.body.classList.remove('damage-flash');
                }, duration);
            }
        }

        function setTab(view) {
            document.querySelectorAll('.game-view').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(`view-${view}`).classList.add('active');
            document.getElementById(`btn-${view}`).classList.add('active');
        }

        function toggleAxis() {
            isHorizontal = !isHorizontal;
            document.getElementById('axis-display').innerText = isHorizontal ? "HORIZ" : "VERT";
        }
        function resetSetup() {
            myShips = []; currentShipIdx = 0; amIReady = false;
            document.querySelectorAll('.cell.occupied').forEach(c => c.classList.remove('occupied'));
            updateSetupUI();
        }
        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>
